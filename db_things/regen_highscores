#!/usr/bin/php
<?php
	function highscores_by_average($a, $b)
	{
		if($a[1] < $b[1]) return 1;
		elseif($a[1] > $b[1]) return -1;
		else return 0;
	}
	
	function highscores_by_overall($a, $b)
	{
		if($a[2] < $b[2]) return 1;
		elseif($a[2] > $b[2]) return -1;
		else return 0;
	}
	
	require('../engine/include.php');

	if(!isset($_SERVER['argv'][1]))
	{
		echo "Usage: ".$_SERVER['argv'][0]." [Database dir]\n";
		exit(1);
	}
	else
		define_globals($_SERVER['argv'][1]);

	function sort_highscores($a, $b)
	{
		if($a[0] < $b[0])
			return 1;
		elseif($a[0] > $b[0])
			return -1;
		else
			return 0;
	}

	$highscores = array();

	$dh = opendir(DB_PLAYERS);
	while(($fname = readdir($dh)) !== false)
	{
		if(!is_file(DB_PLAYERS.'/'.$fname) || !is_readable(DB_PLAYERS.'/'.$fname))
			continue;

		$this_user_array = get_user_array(urldecode($fname));

		if($this_user_array === false)
			continue;

		$new_points = floor($this_user_array['punkte'][0]+$this_user_array['punkte'][1]+$this_user_array['punkte'][2]+$this_user_array['punkte'][3]+$this_user_array['punkte'][4]+$this_user_array['punkte'][5]+$this_user_array['punkte'][6]);

		if(!isset($this_user_array['alliance']))
			$this_user_array['alliance'] = '';
		$highscores[urldecode($fname)] = array($new_points, $this_user_array['alliance']);
		
		unset($this_user_array);
	}
	closedir($dh);

	uasort($highscores, 'sort_highscores');

	$platz = 1;
	$fh = fopen(DB_HIGHSCORES, 'w');
	foreach($highscores as $player=>$punkte)
	{
		fwrite($fh, highscores::make_info($player, $punkte[0], $punkte[1]));

		$this_user_array = get_user_array($player);
		$this_user_array['punkte'][12] = $platz;
		write_user_array($player, $this_user_array);
		unset($this_user_array);

		$platz++;
	}
	fclose($fh);
	
	$alliance_highscores = array();
	
	$dh = opendir(DB_ALLIANCES);
	while(($fname = readdir($dh)) !== false)
	{
		if(!is_file(DB_ALLIANCES.'/'.$fname) || !is_readable(DB_ALLIANCES.'/'.$fname))
			continue;

		$this_alliance_array = get_alliance_array(urldecode($fname));

		if($this_alliance_array === false)
			continue;

		$overall = 0;
		foreach($this_alliance_array['members'] as $member)
			$overall += $member['punkte'];
		$average = floor($overall/count($this_alliance_array['members']));
		
		$alliance_highscores[urldecode($fname)] = array(count($this_alliance_array['members']), $average, $overall);
		
		unset($this_alliance_array);
	}
	closedir($dh);
	
	$alliance_highscores2 = $alliance_highscores;
	uasort($alliance_highscores, 'highscores_by_average');
	uasort($alliance_highscores2, 'highscores_by_overall');
	
	$platz = 1;
	$fh = fopen(DB_HIGHSCORES_ALLIANCES, 'w');
	foreach($alliance_highscores as $alliance=>$info)
	{
		fwrite($fh, highscores_alliances::make_info($alliance, $info[0], $info[1], $info[2]));

		$this_alliance_array = get_alliance_array($alliance);
		$this_alliance_array['platz'] = $platz;
		if(!write_alliance_array($alliance, $this_alliance_array))
			echo 'false';
		unset($this_alliance_array);

		$platz++;
	}
	fclose($fh);
	
	$platz = 1;
	$fh = fopen(DB_HIGHSCORES_ALLIANCES2, 'w');
	foreach($alliance_highscores2 as $alliance=>$info)
	{
		fwrite($fh, highscores_alliances::make_info($alliance, $info[0], $info[1], $info[2]));

		$this_alliance_array = get_alliance_array($alliance);
		$this_alliance_array['platz2'] = $platz;
		if(!write_alliance_array($alliance, $this_alliance_array))
			echo 'false';
		unset($this_alliance_array);

		$platz++;
	}
	fclose($fh);

	unlock_database();
?>
